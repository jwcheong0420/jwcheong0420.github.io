<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/binary-code-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/binary-code-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="StDZENpmNwniZsyIkPBwcXfybLbk5VZzl332sCeAln4">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Sans KR:300,300italic,400,400italic,700,700italic|Nanum Gothic Coding:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jwcheong0420.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="삽질특기생">
<meta property="og:url" content="http://jwcheong0420.github.io/index.html">
<meta property="og:site_name" content="삽질특기생">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Joowon Cheong">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://jwcheong0420.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<script data-ad-client="ca-pub-2651093483415314" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <title>삽질특기생</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">삽질특기생</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">다음에 삽질 덜하려고 만든 블로그</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2021/05/25/express-cannot-set-headers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/express-cannot-set-headers/" class="post-title-link" itemprop="url">[Express.js] Cannot set headers after they are sent to the client</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-25 22:37:33" itemprop="dateCreated datePublished" datetime="2021-05-25T22:37:33+09:00">2021-05-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2021/05/25/express-cannot-set-headers/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/05/25/express-cannot-set-headers/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Express.js에서 res.응답메서드 호출 후 next()를 호출하지 않도록 해야한다.<br>res.응답메서드는 한 번만 쓸 수 있으며, res.send 후에 next()를 하면 다음 미들웨어에서 또 res.응답메서드 호출을 시도하므로 아래와 같은 에러를 출력한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error [ERR_HTTP_HEADERS_SENT]: Cannot <span class="built_in">set</span> headers after they are sent to the client</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2020/12/05/overlayfs-bug-on-xfs-without-d-type-disabled/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/05/overlayfs-bug-on-xfs-without-d-type-disabled/" class="post-title-link" itemprop="url">overlayfs 버그 - xfs 사용 시 ftype=0인 경우 파일 삭제 시 인식하지 못함</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-05 01:43:33" itemprop="dateCreated datePublished" datetime="2020-12-05T01:43:33+09:00">2020-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/12/05/overlayfs-bug-on-xfs-without-d-type-disabled/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/12/05/overlayfs-bug-on-xfs-without-d-type-disabled/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="문제-상황"><a href="#문제-상황" class="headerlink" title="문제 상황"></a>문제 상황</h2><p>환경 세팅 중 crio가 다음과 같은 fatal log를 출력하고 종료되었다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dec 01 18:02:54 bp-master001 crio[8263]: time=<span class="string">&quot;2020-12-01 18:02:54.147849982+09:00&quot;</span> level=fatal msg=<span class="string">&quot;kernel does not support overlay fs: overlay: the backing xfs filesystem is formatted without d_type support, which leads to incorrect behavior. Reformat the filesystem with ftype=1 to enable d_type support. Running without d_type is not supported.: driver not supported&quot;</span></span><br></pre></td></tr></table></figure>
<p>backing filesystem으로 d_type을 지원하지 않는 xfs를 사용하면 비정상적인 동작으로 이끌 수 있으니,<br>ftype&#x3D;1로 파일시스템을 다시 포맷하여 d_type 지원을 활성화시키라는 내용이다.</p>
<h2 id="관련-이슈-확인"><a href="#관련-이슈-확인" class="headerlink" title="관련 이슈 확인"></a>관련 이슈 확인</h2><p>overlayfs에서 위와 같은 상황에서 <a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-fsdevel/patch/20160222142834.GA18393@redhat.com/">삭제된 파일이 삭제되었다고 표시되지 않는 버그</a>가 있다고 한다.</p>
<blockquote>
<p>During mount, make sure upper fs supports d_type otherwise error out.<br>In some instances xfs has been created with ftype&#x3D;0 and there if a file on lower fs is removed, overlay leaves a whiteout in upper fs but that whiteout does not get filtered out and is visible to overlayfs users.<br>And reason it does not get filtered out because upper filesystem does<br>not report file type of whiteout as DT_CHR during iterate_dir().<br>So it seems to be a requirement that upper filesystem support d_type for overlayfs to work properly. Do this check during mount and fail if d_type is not supported.</p>
</blockquote>
<h2 id="버그-재현"><a href="#버그-재현" class="headerlink" title="버그 재현"></a>버그 재현</h2><h3 id="파티션-생성"><a href="#파티션-생성" class="headerlink" title="파티션 생성"></a>파티션 생성</h3><p>테스트를 위한 새로운 파티션을 생성한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fdisk /dev/sdb</span></span><br></pre></td></tr></table></figure>

<details>
<summary>생성 과정</summary>
<div markdown="1">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># fdisk /dev/sdb</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0x4aa3c9aa.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (1-4, default 1): </span><br><span class="line">First sector (2048-16777215, default 2048): </span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-16777215, default 16777215): </span><br><span class="line">Using default value 16777215</span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 8 GiB is <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>
</details>

<h3 id="xfs-생성"><a href="#xfs-생성" class="headerlink" title="xfs 생성"></a>xfs 생성</h3><p>xfs 생성 시 ftype&#x3D;0 옵션을 추가한다.<br>참고로 ftype&#x3D;0은 crc&#x3D;0도 추가해야한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkfs -t xfs -n ftype=0 /dev/sdb1</span></span><br></pre></td></tr></table></figure>

<details>
<summary>생성 과정</summary>
<div markdown="1">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mkfs -t xfs -n ftype=0 -m crc=0 /dev/sdb1</span></span><br><span class="line">meta-data=/dev/sdb1              isize=256    agcount=4, agsize=524224 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=0        finobt=0, sparse=0</span><br><span class="line">data     =                       bsize=4096   blocks=2096896, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=0</span><br><span class="line"><span class="built_in">log</span>      =internal <span class="built_in">log</span>           bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure>
</details>

<details>
<summary>crc=0 없이 생성한 경우</summary>
<div markdown="1">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mkfs -t xfs -n ftype=0 /dev/sdb1</span></span><br><span class="line">cannot <span class="built_in">disable</span> ftype with crcs enabled</span><br><span class="line">Usage: mkfs.xfs</span><br><span class="line">/* blocksize */		[-b <span class="built_in">log</span>=n|size=num]</span><br><span class="line">/* metadata */		[-m crc=0|1,finobt=0|1,uuid=xxx]</span><br><span class="line">/* data subvol */	[-d agcount=n,agsize=n,file,name=xxx,size=num,</span><br><span class="line">			    (sunit=value,swidth=value|su=num,sw=num|noalign),</span><br><span class="line">			    sectlog=n|sectsize=num</span><br><span class="line">/* force overwrite */	[-f]</span><br><span class="line">/* inode size */	[-i <span class="built_in">log</span>=n|perblock=n|size=num,maxpct=n,attr=0|1|2,</span><br><span class="line">			    projid32bit=0|1]</span><br><span class="line">/* no discard */	[-K]</span><br><span class="line">/* <span class="built_in">log</span> subvol */	[-l agnum=n,internal,size=num,logdev=xxx,version=n</span><br><span class="line">			    sunit=value|su=num,sectlog=n|sectsize=num,</span><br><span class="line">			    lazy-count=0|1]</span><br><span class="line">/* label */		[-L label (maximum 12 characters)]</span><br><span class="line">/* naming */		[-n <span class="built_in">log</span>=n|size=num,version=2|ci,ftype=0|1]</span><br><span class="line">/* no-op info only */	[-N]</span><br><span class="line">/* prototype file */	[-p fname]</span><br><span class="line">/* quiet */		[-q]</span><br><span class="line">/* realtime subvol */	[-r extsize=num,size=num,rtdev=xxx]</span><br><span class="line">/* sectorsize */	[-s <span class="built_in">log</span>=n|size=num]</span><br><span class="line">/* version */		[-V]</span><br><span class="line">			devicename</span><br><span class="line">&lt;devicename&gt; is required unless -d name=xxx is given.</span><br><span class="line">&lt;num&gt; is xxx (bytes), xxxs (sectors), xxxb (fs blocks), xxxk (xxx KiB),</span><br><span class="line">      xxxm (xxx MiB), xxxg (xxx GiB), xxxt (xxx TiB) or xxxp (xxx PiB).</span><br><span class="line">&lt;value&gt; is xxx (512 byte blocks).</span><br></pre></td></tr></table></figure>
</div>
</details>

<h3 id="fstab에-mount-정보-추가-및-적용"><a href="#fstab에-mount-정보-추가-및-적용" class="headerlink" title="fstab에 mount 정보 추가 및 적용"></a>fstab에 mount 정보 추가 및 적용</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># vi /etc/fstab</span></span><br><span class="line">/dev/sdb1       /root/ftype0    xfs     defaults        0 0</span><br><span class="line">[root@master ~]<span class="comment"># mkdir /root/ftype0</span></span><br><span class="line">[root@master ~]<span class="comment"># mount -a</span></span><br><span class="line">[root@master ~]<span class="comment"># xfs_info /root/ftype0</span></span><br><span class="line">meta-data=/dev/sdb1              isize=256    agcount=4, agsize=524224 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=0        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=2096896, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=0</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure>

<details>
<summary>(참고) root는 ftyep=1이다</summary>
<div markdown="1">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># xfs_info /</span></span><br><span class="line">meta-data=/dev/mapper/centos-root isize=512    agcount=4, agsize=406016 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=1624064, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure>

</details>

<h3 id="파일-삭제-후-동작-확인"><a href="#파일-삭제-후-동작-확인" class="headerlink" title="파일 삭제 후 동작 확인"></a>파일 삭제 후 동작 확인</h3><p>overlay 디렉토리에서 lower 디렉토리에 있는 파일을 삭제한 뒤 조회하면, 삭제했던 파일이 비정상적으로 조회된다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@master ftype0]<span class="comment"># mkdir overlay-test overlay-test/lower overlay-test/upper overlay-test/workdir overlay-test/overlay</span></span><br><span class="line">[root@master ftype0]<span class="comment"># cd overlay-test/</span></span><br><span class="line">[root@master overlay-test]<span class="comment"># touch lower/lower</span></span><br><span class="line">[root@master overlay-test]<span class="comment"># mount -t overlay -o lowerdir=/root/ftype0/overlay-test/lower,\</span></span><br><span class="line">&gt; upperdir=/root/ftype0/overlay-test/upper,workdir=/root/ftype0/overlay-test/workdir \</span><br><span class="line">&gt; none /root/ftype0/overlay-test/overlay</span><br><span class="line">[root@master overlay-test]<span class="comment"># ls -al overlay/</span></span><br><span class="line">합계 0</span><br><span class="line">drwxr-xr-x. 1 root root  6 12월  5 02:05 .</span><br><span class="line">drwxr-xr-x. 6 root root 58 12월  5 02:05 ..</span><br><span class="line">-rw-r--r--. 1 root root  0 12월  5 02:05 lower</span><br><span class="line">[root@master overlay-test]<span class="comment"># rm overlay/lower </span></span><br><span class="line"><span class="built_in">rm</span>: remove 일반 빈 파일 `overlay/lower<span class="string">&#x27;? y</span></span><br><span class="line"><span class="string">[root@master overlay-test]# ls -al overlay/</span></span><br><span class="line"><span class="string">ls: cannot access overlay/lower: 그런 파일이나 디렉터리가 없습니다</span></span><br><span class="line"><span class="string">합계 0</span></span><br><span class="line"><span class="string">drwxr-xr-x. 1 root root 18 12월  5 02:06 .</span></span><br><span class="line"><span class="string">drwxr-xr-x. 6 root root 58 12월  5 02:05 ..</span></span><br><span class="line"><span class="string">??????????? ? ?    ?     ?             ? lower</span></span><br></pre></td></tr></table></figure>


<details>
<summary> (참고) 정상 시나리오 - ftype=1인 디렉토리에서 overlayfs 동작 확인</summary>
<div markdown="1">

<p>삭제된 파일이 조회되지 않는다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mkdir overlay-test overlay-test/lower overlay-test/upper overlay-test/workdir overlay-test/overlay</span></span><br><span class="line">[root@master ~]<span class="comment"># cd overlay-test/</span></span><br><span class="line">[root@master overlay-test]<span class="comment"># touch lower/lower</span></span><br><span class="line">[root@master overlay-test]<span class="comment"># mount -t overlay -o lowerdir=/root/overlay-test/lower,\</span></span><br><span class="line">&gt; upperdir=/root/overlay-test/upper,workdir=/root/overlay-test/workdir \</span><br><span class="line">&gt; none /root/overlay-test/overlay</span><br><span class="line">[root@master overlay-test]<span class="comment"># ls -al overlay/</span></span><br><span class="line">합계 0</span><br><span class="line">drwxr-xr-x. 1 root root  6 12월  5 02:01 .</span><br><span class="line">drwxr-xr-x. 6 root root 62 12월  5 02:01 ..</span><br><span class="line">-rw-r--r--. 1 root root  0 12월  5 02:01 lower</span><br><span class="line">[root@master overlay-test]<span class="comment"># rm overlay/lower </span></span><br><span class="line"><span class="built_in">rm</span>: remove 일반 빈 파일 `overlay/lower<span class="string">&#x27;? y</span></span><br><span class="line"><span class="string">[root@master overlay-test]# ls -al overlay/</span></span><br><span class="line"><span class="string">합계 0</span></span><br><span class="line"><span class="string">drwxr-xr-x. 1 root root 19 12월  5 02:02 .</span></span><br><span class="line"><span class="string">drwxr-xr-x. 6 root root 62 12월  5 02:01 ..</span></span><br></pre></td></tr></table></figure>

</details>

<h2 id="유관-프로젝트의-대처"><a href="#유관-프로젝트의-대처" class="headerlink" title="유관 프로젝트의 대처"></a>유관 프로젝트의 대처</h2><p>레드햇의 경우 xfs 파일시스템을 사용할 때 주의 사항을 <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/7.2_release_notes/technology-preview-file_systems">문서</a>에 명시되어있고,<br>Docker 역시 overlayfs storage driver를 사용할 때 주의 사항이 <a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/#prerequisites">공식 홈페이지</a>에 명시되어있다.</p>
<p>이러한 버그가 알려져있기 때문에, docker와 cri-o에서는 앞서 소개했었던 fatal log 내용처럼 사전에 확인하는 과정을 추가한 것으로 보인다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>overlayfs의 backing filesystem으로 xfs 파일 시스템을 사용할 때는, xfs 포맷 시 ftype&#x3D;1을 반드시 추가하자.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2020/04/04/kubernetes-resource-mgmt-1-requests-and-limits/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/04/kubernetes-resource-mgmt-1-requests-and-limits/" class="post-title-link" itemprop="url">Kubernetes의 resource 관리(1) - requests와 limits</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-04 00:51:58" itemprop="dateCreated datePublished" datetime="2020-04-04T00:51:58+09:00">2020-04-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/04/kubernetes-resource-mgmt-1-requests-and-limits/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/04/kubernetes-resource-mgmt-1-requests-and-limits/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kubernetes의-Resource-Management"><a href="#Kubernetes의-Resource-Management" class="headerlink" title="Kubernetes의 Resource Management"></a>Kubernetes의 Resource Management</h2><p>Kubernetes에서 resource management하는 것에 대해 정리해보고자 한다. 꽤나 복잡해서 하나의 포스팅으로는 끝나지 않을 것 같아 내용을 나눈다.<br>이번 포스팅은 pod의 spec 중 container별로 설정할 수 있는 resource requests와 limits에 대한 내용이다.</p>
<h3 id="Resource-Requests-amp-Limits"><a href="#Resource-Requests-amp-Limits" class="headerlink" title="Resource Requests &amp; Limits"></a>Resource Requests &amp; Limits</h3><p>Kubernetes에서 pod의 spec을 정의할 때, container별로 CPU와 Memory에 대해서 requests와 limits를 설정할 수 있다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">simple-pod-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="number">0.5</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br></pre></td></tr></table></figure>
<p>CPU의 경우 단위는 core이고, 0.1과 100m, 100 millicore는 모두 같은 값을 의미한다.<br>Memory의 경우 단위는 byte이다.</p>
<h4 id="Requests"><a href="#Requests" class="headerlink" title="Requests"></a>Requests</h4><p>Requests는 pod을 scheduling할 때 참고하며, 실제 container process의 사용량이 이것을 넘는 것은 중요하지 않다.<br>사용자가 생각할 때 ‘이 container는 이 정도의 자원을 필요로 할 것이다’라는 예상치로 정하는 값이다. Soft limit정도로 생각하면 된다.  </p>
<ul>
<li><p>cgroup에 설정되는 값</p>
<p>  CPU의 경우 cpu.shares 값이 설정된다. 만약 container1은 CPU requests로 0.5를, container2는 CPU requests로 1을 지정했다면, A와 B는 1:2의 비율로 스케줄링된다.<br>  Memory는 별도로 설정하는 값이 없다.</p>
<ul>
<li>테스트한 conainer yaml  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">request-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-test-ctr-1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="number">0.5</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-test-ctr-2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">300Mi</span></span><br></pre></td></tr></table></figure></li>
<li>cgroup 확인<ul>
<li><p>pod uuid와 docker container uuid 확인</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/docker-ps.png" alt="docker ps"></p>
<p>  다른 방법들이 많겠지만 나는 그냥 worker node로 접속해서 docker ps를 쳐서 알아내는 편이다.<br>  Docker container name의 형식은 k8s_{container name}<em>{pod name}</em>{namespace}_{pod uuid}이다.</p>
</li>
<li><p>해당 pod의 cgroup 접근</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/pod-cgroup.png" alt="pod cgroup"></p>
<ul>
<li>참고) kubernetes cgroup layout (v1.17 기준)  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubepods</span><br><span class="line">\_ besteffort</span><br><span class="line">    \_ pod&#123;uuid&#125;</span><br><span class="line">        \_ &#123;container uuid&#125;</span><br><span class="line">        \_ &#123;pause container uuid&#125;</span><br><span class="line">        \_ ...</span><br><span class="line">\_ burstable</span><br><span class="line">    \_ pod&#123;uuid&#125;</span><br><span class="line">        \_ &#123;container uuid&#125;</span><br><span class="line">        \_ &#123;pause container uuid&#125;</span><br><span class="line">        \_ ...</span><br><span class="line">\_ pod&#123;uuid&#125;    <span class="comment"># guaranteed pods</span></span><br><span class="line">    \_ &#123;container uuid&#125;</span><br><span class="line">    \_ &#123;pause container uuid&#125;</span><br><span class="line">    \_ ...</span><br><span class="line">\_ ...</span><br></pre></td></tr></table></figure>
  &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;{resource type}&#x2F;kubepods&#x2F;{QoS class}&#x2F;pod{pod uuid}이다.<br>  QoS class가 BestEffort, Burstable, Guaranteed가 있으며, Guaranteed의 경우 추가 cgroup 없이 바로 pod cgroup이 위치한다.<br>  kubepods의 cpu.shares는 {node의 core 수} * 1024, besteffort의 cpu.shares는 2, burstable의 cpu.shares는 256이다. guaranteed cgroup이 따로 없고 바로 pod cgroup이 있는 건 kubernetes가 (같은 core에 대해 경쟁해야하는 상황인 경우)guaranteed pod에게 최대한 자원을 보장하겠다는 의지가 반영된 것이 아닐까 싶다. kubepod의 cpu.shares 수치로 보아서 해당 node는 온전히 kubernetes만을 위한 것이라고 생각하는 것이 아닐까. 뭐 이건 다 추측이다.</li>
</ul>
</li>
<li><p>container별 cpu.shares 확인</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/cpu_shares.png" alt="cpu.shares"></p>
<p>  Pod cgroup의 cpu.shares는 1536, container1 cgroup의 것은 512, container2 cgroup의 것은 1024, pause container의 것은 2가 설정되어 있다.<br>  Kubernetes는 container별로 cpu.shares를 {CPU requests} * 1024 값으로 설정하고, pod의 cpu.shares는 이렇게 request가 지정된 container의 cpu.shares의 합으로 설정한다. (1536 &#x3D; 512 + 1024)</p>
<p>  만약 requests를 설정하지 않으면 2이며, 이 때는 pod cgroup에 합산하지 않는다.<br>  만약 container1의 cpu request를 0.5, container2는 request를 설정하지 않았으면, pod의 cpu.shares는 512이다.<br>  만약 container 1과 2 둘 다 request를 설정하지 않았으면, pod의 cpu.shares는 2이다.<br>  (이러한 계산은 실험공학으로 알아낸 것이므로, 정확한 알고리즘은 나중에 코드를 확인해봐야할 것 같다.)</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Limits"><a href="#Limits" class="headerlink" title="Limits"></a>Limits</h4><p>Limits는 container의 cgroup을 설정할 때 참고하는 값이므로, 실제 container process의 사용량은 이것을 넘지 못한다. Hard limit정도로 생각하면 된다.<br>Requests를 설정했다면 limits는 requests보다 크거나 같은 값이어야 한다. (Requests를 더 큰 값으로 설정할 경우 deploy 시 에러가 발생한다.)<br>Requests를 설정하지 않은 채 limits를 설정한다면, requests는 limits와 동일한 값으로 설정된다.<br>참고로 requests는 설정했지만 limits를 설정하지 않을 수도 있다. 물론 둘 다 설정하지 않아도 된다. CPU와 Memory 둘 중에 하나만 설정할 수도 있다.<br>(어떻게 설정하느냐에 따라서 아까 언급했던 QoS class가 나뉘는데, 이 역시 다른 포스팅에서…)</p>
<ul>
<li><p>cgroup에 설정되는 값</p>
<p>  CPU의 경우 CPU bandwidth quota인 cpu.cfs_quota_us 값이 설정된다.<br>  Memory의 경우 memory 사용률 제한인 memory.limit_in_bytes 값이 설정된다.</p>
<ul>
<li>테스트한 conainer yaml  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">request-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-test-ctr-1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="number">0.5</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">300Mi</span></span><br></pre></td></tr></table></figure></li>
<li>cgroup 확인<ul>
<li><p>container별 cpu.cfs_quota_us 확인</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/cpu_quota.png" alt="cpu.cfs_quota_us"></p>
<p>  Pod의 quota는 50000, container1의 quota도 50000, pause container의 quota는 설정하지 않는다(-1).<br>  Kubernetes는 cfs_quota_us를 {CPU limit} * {cfs_period_us}로 설정하고, cfs_period_us는 kernel default값인 100000을 그대로 사용한다.</p>
<p>  참고로 cfs_quota_us는 -1일 때는 bandwidth 제한을 하지 않는다.<br>  만약 CPU limit을 주지 않을 경우 cfs_quota_us는 -1로 설정된다.</p>
</li>
<li><p>container별 memory.limit_in_bytes 확인</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/mem_limit.png" alt="memory.limit_in_bytes"></p>
<p>  Pod의 limit은 314572800, container1의 limit도 314572800, pause container의 경우 설정하지 않는다.<br>  Kubernetes는 memory.limit_in_bytes를 Memory limit값을 byte로 변환하여 설정한다.</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Memory-stress-test"><a href="#Memory-stress-test" class="headerlink" title="Memory stress test"></a>Memory stress test</h4><ul>
<li><p>시나리오</p>
<ol>
<li>request &amp; limit 설정하지 않았는데 out-of-memory가 발생하는 경우</li>
<li>request 값 &lt; 실 사용량</li>
<li>limit 값 &lt; 실 사용량</li>
</ol>
</li>
<li><p>테스트 과정</p>
<ol>
<li><p>request &amp; limit 설정하지 않았는데 out-of-memory가 발생하는 경우</p>
<ul>
<li>test한 yaml  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">memory-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory-demo-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">polinux/stress</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;stress&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;--vm&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;--vm-bytes&quot;</span>, <span class="string">&quot;1700M&quot;</span>, <span class="string">&quot;--vm-hang&quot;</span>, <span class="string">&quot;1&quot;</span>]</span><br></pre></td></tr></table></figure></li>
<li>테스트 결과<ul>
<li><p>Pod describe 결과</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/mem-stress1.png" alt="mem stress test1"></p>
<p>  해당 pod을 describe해보면 State가 Terminated로 바뀌었고, Reason이 Error라고 명시되어있다.</p>
</li>
<li><p>OOM killer 동작 여부 확인</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/mem-stress1-dmesg.png" alt="dmesg 확인"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>request만 설정하는 경우</p>
<ul>
<li><p>test한 yaml</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">memory-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory-demo-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">polinux/stress</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;stress&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;--vm&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;--vm-bytes&quot;</span>, <span class="string">&quot;500M&quot;</span>, <span class="string">&quot;--vm-hang&quot;</span>, <span class="string">&quot;1&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/mem-stress2.png" alt="mem stress test2"></p>
<p>  해당 pod을 describe해보면 State는 Running으로, 아무런 일도 일어나지 않았다.</p>
</li>
</ul>
</li>
<li><p>limit 설정하는 경우</p>
<ul>
<li><p>test한 yaml</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">memory-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory-demo-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">polinux/stress</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;stress&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;--vm&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;--vm-bytes&quot;</span>, <span class="string">&quot;500M&quot;</span>, <span class="string">&quot;--vm-hang&quot;</span>, <span class="string">&quot;1&quot;</span>]</span><br></pre></td></tr></table></figure></li>
<li><p>테스트 결과</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/mem-stress3.png" alt="mem stress test3"></p>
<p>  해당 pod을 describe해보면 State가 Terminated로 바뀌었고, Reason이 OOMkilled라고 명시되어있다.<br>  OOM killer 역시 동작했다.</p>
<p>  <img src="/images/kubernetes-resource-mgmt-1-requests-and-limits/mem-stress3-dmesg.png" alt="mem stress test3 dmesg"></p>
</li>
</ul>
</li>
</ol>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2020/02/24/review-of-contributing-to-opensource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/24/review-of-contributing-to-opensource/" class="post-title-link" itemprop="url">opensource에 contribute한 후기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-24 01:00:08" itemprop="dateCreated datePublished" datetime="2020-02-24T01:00:08+09:00">2020-02-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/etc/" itemprop="url" rel="index"><span itemprop="name">etc</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/24/review-of-contributing-to-opensource/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/24/review-of-contributing-to-opensource/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>오픈소스에서 버그나 오타를 발견하는 건 사막에서 바늘 찾기라고만 생각했다.<br>그래서 오픈소스에 컨트리뷰트하는 건 나한테는 불가능한 일이고, 대단한 사람들만 하는 것이라고 생각했다.<br>그런데 나에게도 그런 일이 일어났다.</p>
<h2 id="토요일-아침-7시에-오타를-발견하다"><a href="#토요일-아침-7시에-오타를-발견하다" class="headerlink" title="토요일 아침 7시에 오타를 발견하다"></a>토요일 아침 7시에 오타를 발견하다</h2><p>답답함에 못이겼는지 토요일인데도 아침 일찍 눈이 번쩍 떠졌다.<br>나에게 주어진 일이나 잘하자 하고 마음을 다잡으며 nvidia의 gpu device plugin 코드를 분석하려 했는데, 우연찮게 오타를 발견했다!<br><img src="/images/review-of-contributing-to-opensource/found-typo.png" alt="found-typo">  </p>
<p>healtheck라니, healtheck라니!<br>혹시나 내가 healthcheck라고 잘못 알고 있었나 별 생각을 다하면서, 저 부분을 몇 번이고 다시 읽고 구글링도 해보았다ㅋㅋㅋㅋㅋ<br>생각보다 꽤 잘 오타가 나는 부분인지, healthcheck를 여러 번 타이핑할 때 healtheck라고 한 번씩 등장하는 모습을 볼 수 있었다.<br>일단 해보자! 만약 오타가 아니라면 PR(Pull Request)가 받아들여지지 않거나 하겠지. 라는 생각으로 나의 첫 오픈소스 컨트리뷰트 도전이 시작되었다.</p>
<h2 id="Contribute-1차-시도"><a href="#Contribute-1차-시도" class="headerlink" title="Contribute 1차 시도"></a>Contribute 1차 시도</h2><h3 id="README-md-및-CONTRIBUTING-md-읽기"><a href="#README-md-및-CONTRIBUTING-md-읽기" class="headerlink" title="README.md 및 CONTRIBUTING.md 읽기"></a>README.md 및 CONTRIBUTING.md 읽기</h3><p>우선 오픈소스의 README와 CONTRIBUTING 문서를 살펴보았다.<br>README에는 CONTRIBUTING 문서를 살펴보고 PR로 컨트리뷰트하면 된다는 짤막한 문구가 있었고,<br><img src="/images/review-of-contributing-to-opensource/readme.png" alt="README - contributing"><br>CONTRIBUTING에는 오픈소스에 제출한 나의 코드에 대한 권리(<a target="_blank" rel="noopener" href="https://developercertificate.org/">정확한 내용</a>은 모르겠다…)에 대해 commit message에 내 실명을 넣은 한 줄을 추가하면 된단다.<br><img src="/images/review-of-contributing-to-opensource/contributing.png" alt="CONTRIBUTING - sign off"></p>
<h3 id="오픈소스-프로젝트-fork하여-작업하기"><a href="#오픈소스-프로젝트-fork하여-작업하기" class="headerlink" title="오픈소스 프로젝트 fork하여 작업하기"></a>오픈소스 프로젝트 fork하여 작업하기</h3><p>해당 오픈소스의 github 프로젝트를 fork하고, fix-typo라는 브랜치를 따서 작업했다.<br>규칙대로 commit message에는 sign off 한 줄 추가 완료!<br><img src="/images/review-of-contributing-to-opensource/first-commit.png" alt="first commit"></p>
<h3 id="Pull-Request를-올렸다"><a href="#Pull-Request를-올렸다" class="headerlink" title="Pull Request를 올렸다!"></a>Pull Request를 올렸다!</h3><p>PR을 올리고 얼마나 두근대던지, 테스팅 파이프라인을 계속 쳐다보고 별 쇼를 다했다ㅋㅋㅋㅋ<br>그리고 PR을 올리니까 내 contribution activity에 이런 이력도 추가되었다 :)<br><img src="/images/review-of-contributing-to-opensource/first-pull-request.png" alt="first pull request"></p>
<h3 id="읭-Merged가-아니라-왜-Closed냐옹"><a href="#읭-Merged가-아니라-왜-Closed냐옹" class="headerlink" title="읭 Merged가 아니라 왜 Closed냐옹"></a>읭 Merged가 아니라 왜 Closed냐옹</h3><p>30여분 지났는데 해당 오픈소스 collaborator가 답변을 달았다.<br>꽤나 빠른 응답시간에 놀랐고, 답변에 당황했다.<br><img src="/images/review-of-contributing-to-opensource/pull-request-closed.png" alt="pull request closed"><br>github은 gitlab의 것을 mirror한 것이니, gitlab에 다시 해달란다.<br>어… gitlab으로 오픈소스 컨트리뷰트하는 후기들은 못봤는디요… 등에서 식은땀이 흘렀다.</p>
<h2 id="Contribute-2차-시도"><a href="#Contribute-2차-시도" class="headerlink" title="Contribute 2차 시도"></a>Contribute 2차 시도</h2><h3 id="gitlab-가입하기"><a href="#gitlab-가입하기" class="headerlink" title="gitlab 가입하기"></a>gitlab 가입하기</h3><p>구글링해보니 gitlab의 프로젝트를 github으로 옮기는 케이스는 꽤 많은 것 같았다.<br>우선 gitlab에는 회사 메일로 된 계정밖에 없어서 이 기회에 만들었다.<br>혹시 모르니 github과 동일한 아이디와 메일을 사용하도록 가입했다.</p>
<h3 id="오픈소스-프로젝트-fork하여-작업하고-MR-올리기"><a href="#오픈소스-프로젝트-fork하여-작업하고-MR-올리기" class="headerlink" title="오픈소스 프로젝트 fork하여 작업하고, MR 올리기"></a>오픈소스 프로젝트 fork하여 작업하고, MR 올리기</h3><p>처음에 로그인하지 않고 프로젝트 화면을 봤을 때는 fork 버튼이 없어서 당황했었다.<br><img src="/images/review-of-contributing-to-opensource/gitlab-where-is-fork-button.png" alt="where is fork button?"><br>gitlab은 시스템이 다른건가…? 항상 member로만 속해있다가 다른 프로젝트에 contribute하는 건 처음이라…<br>많은 걱정 속에, 일단 gitlab 가입을 하고 로그인을 했더니 바로 fork 버튼이 나타나더라.<br><img src="/images/review-of-contributing-to-opensource/gitlab-after-login.png" alt="fork button appeared after login"><br>1차 시도 때했던 작업을 동일하게 한 뒤, MR(Merge Request, gitlab에서는 PR이 아니라 MR)을 올렸다.</p>
<h3 id="Merged"><a href="#Merged" class="headerlink" title="Merged!"></a>Merged!</h3><p>또 30분 정도 뒤에 메일이 왔는데 이번엔 Closed가 아니라 Merged 되었다는 메일이었다:)<br><img src="/images/review-of-contributing-to-opensource/merge-request-gitlab.png" alt="merge request"></p>
<h3 id="mirror된-github에서도-한번-확인"><a href="#mirror된-github에서도-한번-확인" class="headerlink" title="mirror된 github에서도 한번 확인"></a>mirror된 github에서도 한번 확인</h3><p>github에서는 내 commit이 어떻게 보일까 궁금해서 다시 한 번 확인해보았다.<br>아이디가 같아서인지, 저 아이디의 아이콘을 클릭하면 내 github 페이지로 이동하더라.<br><img src="/images/review-of-contributing-to-opensource/commit-more.png" alt="commit at github">  </p>
<p>이제 내가 고친 파일의 contributor 목록에 내가 보인다(흐-뭇)<br><img src="/images/review-of-contributing-to-opensource/contributors.png" alt="contributors"></p>
<h2 id="후기"><a href="#후기" class="headerlink" title="후기"></a>후기</h2><p>오타를 발견하고 컨트리뷰트하기까지 약 반나절이 걸렸다.<br>너무나도 신선한 경험이었고, 토요일 아침에 발견해서 그런지 이번 주말은 뿌듯한 마음으로 잘 쉬었다.(응?)<br>역시 마음 조급해할 것 없이, 내가 할 일을 하면 되는구나 싶기도 하고…<br>큰 오픈소스 프로젝트도 아니고 별 거 아닌 오타 수정일 뿐이지만, 높아만 보였던 오픈소스 컨트리뷰트의 문턱을 넘어서 기쁘다.<br>그런데 아직도 의문인건 request를 보내면 30분 안에 답이 오는 저 열일하시는 분… 역시 nvidia인건가? 멋져…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2020/02/13/using-sysctls-in-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/13/using-sysctls-in-k8s/" class="post-title-link" itemprop="url">Kubernetes에서 sysctls 설정 변경하는 방법(feat. proc & sysctl)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-13 21:55:30" itemprop="dateCreated datePublished" datetime="2020-02-13T21:55:30+09:00">2020-02-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/13/using-sysctls-in-k8s/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/13/using-sysctls-in-k8s/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>proc file system과 sysctl command, ipc namespace 분리 테스트까지</p>
<h2 id="proc-file-system과-sysctl-command"><a href="#proc-file-system과-sysctl-command" class="headerlink" title="proc file system과 sysctl command"></a>proc file system과 sysctl command</h2><h3 id="proc-file-system"><a href="#proc-file-system" class="headerlink" title="proc file system"></a>proc file system</h3><h4 id="proc-file-system이란"><a href="#proc-file-system이란" class="headerlink" title="proc file system이란"></a>proc file system이란</h4><ul>
<li>Unix 계열 OS에서 프로세스와 다른 시스템 정보를 계층적인 파일 구조 같은 형식으로 보여주는 pseudo filesystem</li>
<li>부트 타임에 &#x2F;proc이라는 마운트 포인트에 매핑</li>
<li>커널에서 내부 데이터 구조체에 대한 인터페이스처럼 행동<ul>
<li>커널 영역과 사용자 영역 사이의 통신에 대한 방식 제공</li>
</ul>
</li>
<li>런타임(sysctl) 시에 특정한 커널 파라미터를 바꾸고 시스템에 대한 정보를 얻는데 사용될 수 있음</li>
</ul>
<h4 id="x2F-proc-하위-구조"><a href="#x2F-proc-하위-구조" class="headerlink" title="&#x2F;proc 하위 구조"></a>&#x2F;proc 하위 구조</h4><ul>
<li>&#x2F;proc&#x2F;{PID}<ul>
<li>(커널 프로세스를 포함하는) 실행 중인 프로세스 별로 디렉토리가 존재</li>
</ul>
</li>
<li>&#x2F;proc&#x2F;crypto<ul>
<li>사용 가능한 암호화 모듈들에 대한 목록</li>
</ul>
</li>
<li>&#x2F;proc&#x2F;devices<ul>
<li>장치 ID에 의해 정렬된 캐릭터와 블록 장치 뿐 아니라 &#x2F;dev 이름에 대한 목록</li>
</ul>
</li>
<li>&#x2F;proc&#x2F;filesystems<ul>
<li>리스팅 시의 커널에 의해 지원되는 파일 시스템들의 목록</li>
</ul>
</li>
<li>&#x2F;proc&#x2F;sys<ul>
<li>동적으로 설정 가능한 커널 옵션들에 대한 인터페이스</li>
</ul>
</li>
<li>(생략)</li>
</ul>
<h4 id="왜-proc-file-system을-사용하는가"><a href="#왜-proc-file-system을-사용하는가" class="headerlink" title="왜 proc file system을 사용하는가?"></a>왜 proc file system을 사용하는가?</h4><ul>
<li>파일 시스템 오버 헤드를 줄일 수 있음<ul>
<li>일반적인 파일시스템은 오버헤드가 많다<ul>
<li>각 파일의 inode, superblocks와 같은 객체를 관리해야 함</li>
<li>이런 정보를 필요할 때마다 OS에 요청해야 함</li>
<li>이런 정보들은 서로 어긋날 수도 있고, 단편화 현상이 발생할 수도 있음</li>
</ul>
</li>
<li>procfs은 리눅스 커널에서 직접 파일시스템을 관리하는 방법을 채택</li>
<li>procfs은 커널메모리에서 돌아가는 가상 파일 시스템</li>
</ul>
</li>
<li>물리적인 파일시스템 장치를 필요로 하지 않음<ul>
<li>커널 메모리에서 유지하는 파일 시스템</li>
</ul>
</li>
<li>최적화된 파일 작업 수행<ul>
<li>proc 하위 파일들은 고정적이고 처리해야할 데이터 양이 적으므로, open&#x2F;read&#x2F;write&#x2F;close 등을 사용하여 데이터를 다루는 것이 비효율적</li>
</ul>
</li>
</ul>
<h4 id="proc-프로그래밍"><a href="#proc-프로그래밍" class="headerlink" title="proc 프로그래밍"></a>proc 프로그래밍</h4><h5 id="user와-데이터-교환법"><a href="#user와-데이터-교환법" class="headerlink" title="user와 데이터 교환법"></a>user와 데이터 교환법</h5><ul>
<li>procfs의 데이터는 파일에 저장되는 것이 아니라 커널 메모리에 저장하며, 커널 메모리는 유저레벨에서 직접 접근 불가능<ul>
<li>user가 cat(혹은 read 함수)를 통해 파일의 내용을 읽으려하면, 커널에서 데이터를 유저에게 일정한 포맷으로 뿌려줌</li>
<li>user가 어떤 내용을 proc 파일에 쓰게되면 데이터를 받아들이고 가공해서 커널 메모리에 로드</li>
</ul>
</li>
<li>kernel와 user 사이에 데이터를 전달해주는 callback 함수를 등록시켜서 사용  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># proc_dir_entry에 read/write를 위한 callback 함수를 등록</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">entry</span>;</span></span><br><span class="line"></span><br><span class="line">entry-&gt;read_proc = read_proc_foo;</span><br><span class="line">entry-&gt;write_proc = write_proc_foo;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="proc-file-system-소스-코드"><a href="#proc-file-system-소스-코드" class="headerlink" title="proc file system 소스 코드"></a>proc file system 소스 코드</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/tree/master/fs/proc">https://github.com/torvalds/linux/tree/master/fs/proc</a></li>
</ul>
<h3 id="sysctl-command"><a href="#sysctl-command" class="headerlink" title="sysctl command"></a>sysctl command</h3><ul>
<li>동작<ul>
<li>동적으로 커널 파라미터를 설정</li>
<li>&#x2F;proc&#x2F;sys 하위에 있는 파라미터만 가능</li>
</ul>
</li>
<li>사용법<ul>
<li>sysctl -w {param}&#x3D;”{value}”<ul>
<li>일시적으로 해당 파라미터를 설정</li>
<li>재부팅 시 유지되지 않음</li>
</ul>
</li>
<li>sysctl -p{file_path}<ul>
<li>file_path로부터 sysctl 설정을 로드</li>
<li>file_path가 주어지지 않으면 &#x2F;etc&#x2F;sysctl.conf을 로드</li>
</ul>
</li>
</ul>
</li>
<li>참고<ul>
<li>부팅 시점에 &#x2F;proc mount 후 sysctl에 의해 &#x2F;etc&#x2F;sysctl.conf가 자동으로 로드됨</li>
</ul>
</li>
</ul>
<h2 id="K8S에서의-sysctl-설정-방법"><a href="#K8S에서의-sysctl-설정-방법" class="headerlink" title="K8S에서의 sysctl 설정 방법"></a>K8S에서의 sysctl 설정 방법</h2><ul>
<li>K8S에서 커널 파라미터 변경을 위해 sysctls spec을 설정할 수 있음</li>
<li>sysctls<ul>
<li>safe와 unsafe 파라미터를 구분하여 관리</li>
<li>safe 파라미터는 default로 enable<ul>
<li>kernel.shm_rmid_forced</li>
<li>net.ipv4.ip_local_port_range</li>
<li>net.ipv4.tcp_syncookies</li>
</ul>
</li>
<li>unsafe 파라미터는 cluster admin을 통해 node별로 enable해야 함<ul>
<li>disabled unsafe sysctls를 사용한 pod은 스케줄링까지는 되지만, launch는 실패</li>
</ul>
</li>
</ul>
</li>
<li>unsafe sysctls를 enable하는 방법<ul>
<li>node별로 kubelet에 다음과 같은 설정을 추가하여 기동  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubelet --allowed-unsafe-sysctls ‘&#123;원하는 kernel 파라미터&#125;’ ...</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><h3 id="테스트-환경"><a href="#테스트-환경" class="headerlink" title="테스트 환경"></a>테스트 환경</h3><p><img src="/images/using-sysctls-in-k8s/test-cluster.png" alt="test한 cluster 정보"></p>
<h3 id="테스트-과정"><a href="#테스트-과정" class="headerlink" title="테스트 과정"></a>테스트 과정</h3><ul>
<li><p>enable되지 않은 unsafe 파라미터를 수정하는 pod deploy</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">joo-modify-sysctl</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">sysctls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kernel.sem</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;10000   1024000000      500     32000&quot;</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@K8S-3-1:~/joo$ k apply -f sysctl_test.yaml</span><br><span class="line">pod/joo-modify-sysctl created</span><br></pre></td></tr></table></figure>
<p>  <img src="/images/using-sysctls-in-k8s/failed-default.png" alt="sysctl 변경 실패 - SysctlForbidden"><br>  <img src="/images/using-sysctls-in-k8s/failed-default-describe.png" alt="sysctl 변경 실패 - SysctlForbidden"></p>
</li>
<li><p>kubelet config에 sysctl unsafe parameter 활성화</p>
<ul>
<li>kubelet 설정에 –allowed-unsafe-sysctls ‘kernel.sem’ 추가  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@K8S-3-5:~$ vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></pre></td></tr></table></figure>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_EXTRA_ARGS=--feature-gates=DevicePlugins=true --allowed-unsafe-sysctls &#x27;kernel.sem&#x27;&quot;</span></span><br><span class="line"><span class="comment"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/default/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure></li>
<li>설정 reload  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@K8S-3-5:~$ systemctl daemon-reload</span><br></pre></td></tr></table></figure></li>
<li>kubelet restart  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@K8S-3-5:~$ systemctl restart kubelet</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>pod 다시 deploy</p>
<ul>
<li>deploy 성공  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@K8S-3-1:~/joo$ k get pods -o wide</span><br><span class="line">NAME                                   READY     STATUS              RESTARTS   AGE       IP                NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">joo-modify-sysctl                      0/1       ContainerCreating   0          2s        &lt;none&gt;            k8s-3-5   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></li>
<li>kernel.sem 비교  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@K8S-3-1:~$ <span class="built_in">cat</span> /proc/sys/kernel/sem</span><br><span class="line">32000   1024000000      500     32000</span><br><span class="line">root@K8S-3-1:~$ k <span class="built_in">exec</span> -it joo-modify-sysctl /bin/bash</span><br><span class="line">root@joo-modify-sysctl:/$ <span class="built_in">cat</span> /proc/sys/kernel/sem</span><br><span class="line">10000   1024000000      500     32000</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="kernel-sem-기본값-확인"><a href="#kernel-sem-기본값-확인" class="headerlink" title="kernel.sem 기본값 확인"></a>kernel.sem 기본값 확인</h2><ul>
<li>kernel src :  <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/v4.15/include/uapi/linux/sem.h#L79">https://github.com/torvalds/linux/blob/v4.15/include/uapi/linux/sem.h#L79</a><br>  <img src="/images/using-sysctls-in-k8s/kernel-sem-default-value.png" alt="kernel.sem default value"></li>
<li>cat &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sem<br>  <img src="/images/using-sysctls-in-k8s/proc-sys-kernel-sem.png" alt="/proc/sys/kernel/sem"><ul>
<li>SEMMSL: max semaphores per array</li>
<li>SEMMNS: maximum semaphores system-wide</li>
<li>SEMOPM : maximum operations per semop call</li>
<li>SEMMNI: maximum arrays</li>
</ul>
</li>
</ul>
<h2 id="IPC-namespace-분리-시-kernel-sem-값-확인"><a href="#IPC-namespace-분리-시-kernel-sem-값-확인" class="headerlink" title="IPC namespace 분리 시 kernel.sem 값 확인"></a>IPC namespace 분리 시 kernel.sem 값 확인</h2><p>kernel.sem parameter는 IPC namespace가 분리되면 host와 다른 값(default 값)을 가짐<br>parameter별로 어떤 namespace에 의해 분리되는지는 다름</p>
<h3 id="테스트-과정-1"><a href="#테스트-과정-1" class="headerlink" title="테스트 과정"></a>테스트 과정</h3><ul>
<li>default kernel.sem 확인<ul>
<li>cat &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sem</li>
</ul>
</li>
<li>sysctl로 kernel.sem 변경<ul>
<li>sysctl -w kernel.sem&#x3D;”33000   1024000000 500 32000”</li>
</ul>
</li>
<li>host ipc namespace에서의 kernel.sem을 출력하고, 새로운 ipc ns를 갖는 자식 process를 생성하여 kernel.sem을 출력하는 프로그램 실행<br>  <img src="/images/using-sysctls-in-k8s/ipc-ns-test.png" alt="ipc namespace 분리 시 kernel.sem 값 확인"></li>
<li>a.out 소스  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> child_stack[<span class="number">1048576</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">child_fn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;at child - new ipc ns\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /proc/sys/kernel/sem&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;at parent - host ipc ns\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /proc/sys/kernel/sem&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">pid_t</span> child_pid = clone(child_fn, child_stack+<span class="number">1048576</span>, CLONE_NEWIPC | SIGCHLD, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h2><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Procfs">https://en.wikipedia.org/wiki/Procfs</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/proc.html">https://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/proc.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.joinc.co.kr/w/Site/system_programing/proc/ProcFsPrograming">https://www.joinc.co.kr/w/Site/system_programing/proc/ProcFsPrograming</a></li>
<li><a target="_blank" rel="noopener" href="http://jake.dothome.co.kr/proc/">http://jake.dothome.co.kr/proc/</a></li>
<li><a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man2/sysctl.2.html">http://man7.org/linux/man-pages/man2/sysctl.2.html</a></li>
<li><a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man8/sysctl.8.html">http://man7.org/linux/man-pages/man8/sysctl.8.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.toptal.com/linux/separation-anxiety-isolating-your-system-with-linux-namespaces">https://www.toptal.com/linux/separation-anxiety-isolating-your-system-with-linux-namespaces</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2020/02/11/cgroup-v2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/11/cgroup-v2/" class="post-title-link" itemprop="url">cgroup v2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-11 17:17:49" itemprop="dateCreated datePublished" datetime="2020-02-11T17:17:49+09:00">2020-02-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/11/cgroup-v2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/11/cgroup-v2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>cgroup v2에 포커싱을 맞춰서 조사해보았다</p>
<h2 id="cgroup이란"><a href="#cgroup이란" class="headerlink" title="cgroup이란"></a>cgroup이란</h2><ul>
<li><strong>process를 계층적인 group으로</strong> 구성해서, <strong>resource 사용을 제한하고 모니터링</strong>할 수 있는 linux kernel feature</li>
<li>cgroup의 interface는 <strong>cgroupfs</strong>이라 불리는 pseudo-filesystem을 통해 제공됨<ul>
<li>cgroupfs의 <strong>subdirectory를 생성&#x2F;삭제&#x2F;변경</strong>하면서 정의됨</li>
</ul>
</li>
</ul>
<h2 id="구조"><a href="#구조" class="headerlink" title="구조"></a>구조</h2><ul>
<li>core<ul>
<li>process를 계층적으로 관리</li>
</ul>
</li>
<li>subsystem(&#x3D;&#x3D; resource controller &#x3D;&#x3D; controller)<ul>
<li>resource tracking과 제한</li>
<li>cgroup에 속한 process의 행동을 변경함<ul>
<li>resource 제한이나 모니터링을 하면서 process를 freeze시키거나 resume(다시 시작)하는 등</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="사용법"><a href="#사용법" class="headerlink" title="사용법"></a>사용법</h2><h3 id="mounting"><a href="#mounting" class="headerlink" title="mounting"></a>mounting</h3><ul>
<li>v1<ul>
<li>controller별로 mount하여 사용 가능  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -t tmpfs cgroup_root /sys/fs/cgroup</span><br><span class="line"><span class="built_in">mkdir</span> /sys/fs/cgroup/cpuset</span><br><span class="line">mount -t cgroup cpuset -ocpuset /sys/fs/cgroup/cpuset</span><br></pre></td></tr></table></figure>
  <img src="/images/cgroup-v2/cgroup-hierarchy-v1.png" alt="cgroup hierarchy v1"></li>
</ul>
</li>
<li>v2<ul>
<li>unified cgroup hierarchy  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cgroup2 none <span class="variable">$MOUNT_POINT</span></span><br></pre></td></tr></table></figure>
  <img src="/images/cgroup-v2/cgroup-mounting-v2.png" alt="cgroup mounting example v2"><br>  <img src="/images/cgroup-v2/cgroup-hierarchy-v2.png" alt="cgroup hierarchy v2"></li>
</ul>
</li>
</ul>
<h2 id="subtree-control-cgroup2-gt-아직-잘-모르겠다"><a href="#subtree-control-cgroup2-gt-아직-잘-모르겠다" class="headerlink" title="subtree control(cgroup2) -&gt; 아직 잘 모르겠다"></a>subtree control(cgroup2) -&gt; 아직 잘 모르겠다</h2><ul>
<li>cgroup.controllers<ul>
<li>read-only file</li>
<li>해당 cgroup에 available한 controller의 list를 노출</li>
<li>부모 cgroup의 cgroup.subtreee_control과 내용이 동일함???</li>
</ul>
</li>
<li>cgroup.subtree_control<ul>
<li>해당 cgroup에 활성화되어있는 controller 목록</li>
<li>해당 cgroup의 cgroup.controllers에 있는 subset????</li>
<li>이 파일에 +, -로 controller들을 활성화, 비활성화 가능  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;+pids -memory&#x27;</span> &gt; x/y/cgroup.subtree_control</span><br></pre></td></tr></table></figure>
<ul>
<li>cgroup.controllers에 없는 controller를 enable시키려하면 ENOENT 에러 발생  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> cgroup.controllers        <span class="comment"># 사용 가능한 controller 없음 확인</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-io&quot;</span> &gt; cgroup.subtree_control    <span class="comment"># 문제 없음</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;+io&quot;</span> &gt; cgroup.subtree_control    <span class="comment"># cgroup.controllers에 없으므로 에러 발생</span></span><br></pre></td></tr></table></figure>
  <img src="/images/cgroup-v2/subtree-control-example.png" alt="subtree control example"></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="thread-mode-cgroup2"><a href="#thread-mode-cgroup2" class="headerlink" title="thread mode (cgroup2)"></a>thread mode (cgroup2)</h2><ul>
<li>Linux 4.14에 추가<ul>
<li>cpu와 같은 몇몇 controller들은 thread-level granularity 제어가 유용하기 때문</li>
</ul>
</li>
<li>root가 아닌 cgroup은 cgroup.type 파일이 있음<ul>
<li>type value<ul>
<li>domain(default)<ul>
<li>nomal v2 cgroup</li>
<li>process-granularity</li>
</ul>
</li>
<li>threaded<ul>
<li>threaded subtree의 멤버 cgroup</li>
<li>process가 추가될 수 있고 controller가 활성화될 수 있음</li>
</ul>
</li>
<li>domain threaded<ul>
<li>threaded subtree의 root처럼 여겨지는 domain cgroup</li>
</ul>
</li>
<li>domain invalid<ul>
<li>threaded subtree 안에 있는 invalid 상태인 cgroup</li>
<li>process가 추가될 수 없고 controller도 활성화될 수 없음</li>
<li>할 수 있는 단 한 가지 일은 이 cgroup을 threaded cgroup으로 바꾸는 것 뿐</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>threaded controllers &#x2F; domain controllers<ul>
<li>threaded controllers<ul>
<li>cpu, perf_event, pids</li>
</ul>
</li>
<li>domain controllers<ul>
<li>threaded subtree에서는 활성화될 수 없음</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="deprecated-v1-core-features"><a href="#deprecated-v1-core-features" class="headerlink" title="deprecated v1 core features"></a>deprecated v1 core features</h2><ol>
<li><p>Multiple hierarchies including named ones are not supported.</p>
<ul>
<li>같은 계층에 여러 controller를 mount할 수 있었음</li>
<li>named hierarchies<ul>
<li>controller가 attach되지 않은 cgroup 계층도 mount 가능했었음</li>
<li>각 계층은 unique한 이름을 가져야 함  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cgroup -o none,name=somename none /some/mount/point</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>All v1 mount options are not supported.</p>
<ul>
<li>v1의 경우, 원래는 controller별로 mount가 가능했을 뿐 아니라 모든 controller를 mount 하는 기능이 있었음 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cgroup xxx /sys/fs/cgroup  <span class="comment"># xxx는 cgroup과는 관계가 없고 /proc/mounts에 나타날 내용이므로 마음대로 유용하고 식별 가능한 이름을 사용하면 됨</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>The “tasks” file is removed and “cgroup.procs” is not sorted.</p>
<ul>
<li>v1<ul>
<li>tasks에 pid를 관리하고 cgroup.procs라는 파일에 tgid를 관리했었음<br>  <img src="/images/cgroup-v2/kernel-doc-cgroup-v1-tasks.png" alt="tasks in cgroup v1"></li>
<li>cgroup.procs는 tgid를 정렬하고 중복제거 했었음<br>  <img src="/images/cgroup-v2/kernel-doc-cgroup-v1-procs.png" alt="cgroup.procs in cgroup v1"></li>
</ul>
</li>
<li>v2<ul>
<li>croups.procs에 pid를 관리하고, 중복제거 및 정렬되지 않음</li>
</ul>
</li>
</ul>
</li>
<li><p>“cgroup.clone_children” is removed.</p>
<ul>
<li>cpuset controller에만 영향을 미치는 flag</li>
<li>1로 활성화되어있으면, 새로운 cpuset cgroup이 초기화하는 동안 부모로부터 설정을 복사했었음</li>
</ul>
</li>
<li><p>&#x2F;proc&#x2F;cgroups is meaningless for v2.  Use “cgroup.controllers” file at the root instead.</p>
<ul>
<li>v1<ul>
<li>&#x2F;proc&#x2F;cgroups에 kernel에 compile되어 들어간 controller에 대한 정보를 담고 있음<br>  <img src="/images/cgroup-v2/proc-cgroups-v1.png" alt="/proc/cgroups in v1"><br>  <img src="/images/cgroup-v2/kernel-doc-cgroup-v1-proc-cgroups.png" alt="/proc/cgroups values"></li>
</ul>
</li>
<li>v2<ul>
<li>cgroup2는 controller별로 mount하는 것이 아니기 때문에, 한 계층에 여러 controller가 mount되어있는지 여부를 관리할 필요가 없기 때문에 없어진 것 같음<br>  <img src="/images/cgroup-v2/cgroup-controllers-v2.png" alt="cgroup.controllers"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="v1에서의-이슈-v2의-근거"><a href="#v1에서의-이슈-v2의-근거" class="headerlink" title="v1에서의 이슈(v2의 근거)"></a>v1에서의 이슈(v2의 근거)</h2><ol>
<li><p>Multiple Hierarchies</p>
<ul>
<li>문제점 @v1<ul>
<li>v1은 임의의 계층을 만들 수 있고, 각 계층에 몇 개의 controller가 mount되어도 상관없었음. 이것은 flexibility를 보장하는 것 같았지만, 실상은 유용하지 않았음<ul>
<li>cpu, cpuacct와 같은 밀접하게 관련된 것들만 같은 계층에 mount되어 사용됨</li>
<li>결국 사용자가 각 계층마다 비슷한 계층구조를 반복해서 만들게 됨</li>
</ul>
</li>
<li>이에 대한 core 구현이 너무 복잡하여 비용이 큼</li>
<li>계층이 몇개가 되던 limit이 없었음</li>
<li>다른 controller의 토폴로지를 예상할 수 없었기 때문에, 각 controller는 다른 모든 controller가 완전히 직교 계층 구조에 연결되어있다고 생각해야 함<ul>
<li>일반적으로 요구되는 것은, 특정 controller에 따라 다른 수준의 granularity(세분성)을 갖는 것<ul>
<li>ex) 특정 레벨 전까지는 memory는 관리 안하고, CPU 관리는 하길 바라는 등</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>개선 @v2<ul>
<li>모든 controller가 하나의 계층에 mount됨</li>
<li>subtree control로 controller 관리</li>
</ul>
</li>
</ul>
</li>
<li><p>Thread Granularity</p>
<ul>
<li>문제점 @v1<ul>
<li>v1은 thread가 다른 cgroup에 속할 수 있었음<ul>
<li>몇몇 controller와는 사상이 맞지 않음<ul>
<li>ex) 하나의 process에 있는 thread들은 memory를 공유하므로 다른 memory cgroup에 속할 수 없음</li>
</ul>
</li>
</ul>
</li>
<li>v1은 모호하게 정의된 delegated(위임) 모델이어서, thread granularity(세분성)이 남용됨<ul>
<li>cgroup은 개별 application에 위임되어서, 자체적으로 하위 계층을 만들고 관리하고 그에 따른 리소스 분배를 제한할 수 있었음</li>
<li>cgroup은 이렇게 노출되기 때문에 근본적으로 부적절한 interface를 갖고 있음<ul>
<li>&#x2F;proc&#x2F;self&#x2F;cgroup에서 대상 계층 구조의 path를 추출<br>  -&gt; knob(손잡이) 이름을 path에 추가하여 path를 구성<br>  -&gt; open하여 read&#x2F;write함</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>개선 @v2<ul>
<li>process granularity<ul>
<li>process 단위로 cgroup에 속할 수 있음</li>
<li>하나의 process에 속하는 모든 thread는 같은 cgroup에 속함</li>
<li>Linux 4.14의 thread mode 추가로 인해 rule이 몇몇 case에 대해서 완화됨</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Other Interface Issues -&gt; 잘 모르겠다</p>
<ul>
<li>core에서 empty cgroup에 알림을 보내는 것 관련하여 event 전달 매커니즘이 이상함</li>
<li>controller 역시 계층적 조직을 완전히 무시하고 모든 cgroup을 마치 root cgroup 바로 아래에 있는 것처럼 취급하여 문제가 많음</li>
</ul>
</li>
<li><p>Controller Issues and Remedies</p>
<ul>
<li>Memory<ul>
<li>soft limit &#x2F; hard limit 관련 이슈 개선</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="왜-cgroup-v2로-빨리-migrate할-수-없는가"><a href="#왜-cgroup-v2로-빨리-migrate할-수-없는가" class="headerlink" title="왜 cgroup v2로 빨리 migrate할 수 없는가?"></a>왜 cgroup v2로 빨리 migrate할 수 없는가?</h2><ul>
<li>device controller와 freezer에 대한 지원이 없어서 container한테 유용하지 않았음<ul>
<li>device controller가 없어서 container 안의 root user가 device file에 바로 접근할 수 있음</li>
<li>container를 freeze할 수 없어서 TOCTOU 공격에 예방하지 못함</li>
<li>4.15 (2018&#x2F;01)에 device controller 지원</li>
<li>5.2에 freezer 지원</li>
</ul>
</li>
<li>v1과 v2은 호환되지 않기 때문에, v1에서 v2로 migrate하는 것이 어려움<ul>
<li>v1과 v2를 혼합해서 사용하는 hybird 옵션이 있긴 하지만, 이미 v1에 활성화되어있는 controller를 v2에 활성화시키지 못하므로 container에 잘 사용되지 않음</li>
</ul>
</li>
</ul>
<h2 id="cgroup2-사용처"><a href="#cgroup2-사용처" class="headerlink" title="cgroup2 사용처"></a>cgroup2 사용처</h2><ul>
<li>Linux 배포판<ul>
<li>Fedora 31에 default로 adopt됨</li>
<li>Linux 4.2 이상이고 systemd가 v226 이상인 경우, systemd.unified_cgroup_hierarchy&#x3D;1 옵션을 kernel argument에 추가하면 동작</li>
</ul>
</li>
<li>low-level container runtimes<ul>
<li>runc<ul>
<li>최초 지원 시작(2019&#x2F;09, <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc/pull/2113">https://github.com/opencontainers/runc/pull/2113</a>)</li>
<li>여러 문제로 아직 정식으로 지원하지는 않음<ul>
<li><img src="/images/cgroup-v2/runc-cgroup2.png" alt="runc not support cgroup v2 yet"></li>
</ul>
</li>
<li>Issue Tracking<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc/issues?utf8=%E2%9C%93&amp;q=is:issue+is:open+cgroup2">https://github.com/opencontainers/runc/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+is%3Aopen+cgroup2</a></li>
</ul>
</li>
</ul>
</li>
<li>crun<ul>
<li>Red Hat이 이끌고 있는 OCI Runtime Spec</li>
<li>cgroup v2 full support 제공</li>
<li>Fedora 31에 default runtime으로 adopt됨</li>
</ul>
</li>
<li>lxc<ul>
<li>merge된 PR들이 보이긴 하는데…?<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/lxc/lxc/pull/2897">https://github.com/lxc/lxc/pull/2897</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lxc/lxc/pull/3120">https://github.com/lxc/lxc/pull/3120</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lxc/lxc/pull/3194">https://github.com/lxc/lxc/pull/3194</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>high-level container runtimes<ul>
<li>containerd<ul>
<li>Merged<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/pull/3799">https://github.com/containerd/containerd/pull/3799</a></li>
</ul>
</li>
<li>Tracking Issue<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/issues/3726">https://github.com/containerd/containerd/issues/3726</a></li>
</ul>
</li>
</ul>
</li>
<li>Docker &#x2F; Moby<ul>
<li>Merged<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/pull/40174">https://github.com/moby/moby/pull/40174</a></li>
</ul>
</li>
<li>Tracking Issue<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/40360">https://github.com/moby/moby/issues/40360</a></li>
</ul>
</li>
</ul>
</li>
<li>Podman<ul>
<li>crun과 함께 지원</li>
<li>Fedora 31이라면 별도의 설정 변경 없이 사용 가능</li>
<li>cpu controller에 대한 제한 사항이 있음<br>  <img src="/images/cgroup-v2/podman-cgroup2-cpu-controller-limit.png" alt="problem with cgroup2 about cpu controller in podman"></li>
</ul>
</li>
</ul>
</li>
<li>Kubernetes<ul>
<li>KEP(Kubernetes Enhancement Proposal) 추가를 위한 PR opened<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/enhancements/pull/1370">https://github.com/kubernetes/enhancements/pull/1370</a></li>
</ul>
</li>
<li>alpha version 2020</li>
<li>fully support 2021~2022</li>
</ul>
</li>
</ul>
<h2 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h2><ul>
<li><a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man7/cgroups.7.html">http://man7.org/linux/man-pages/man7/cgroups.7.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v2.txt">https://www.kernel.org/doc/Documentation/cgroup-v2.txt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt">https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.redhat.com/en/blog/world-domination-cgroups-rhel-8-welcome-cgroups-v2">https://www.redhat.com/en/blog/world-domination-cgroups-rhel-8-welcome-cgroups-v2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.man7.org/conf/lca2019/cgroups_v2-LCA2019-Kerrisk.pdf">http://www.man7.org/conf/lca2019/cgroups_v2-LCA2019-Kerrisk.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/nttlabs/cgroup-v2-596d035be4d7">https://medium.com/nttlabs/cgroup-v2-596d035be4d7</a></li>
<li><a target="_blank" rel="noopener" href="https://serverfault.com/questions/929080/list-of-controllers-empty-with-cgroup-v2">https://serverfault.com/questions/929080/list-of-controllers-empty-with-cgroup-v2</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc#releases">https://github.com/opencontainers/runc#releases</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2020/02/05/enabling-swap-in-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/05/enabling-swap-in-k8s/" class="post-title-link" itemprop="url">Kubernetes에서 swap 사용하는 방법</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-05 23:22:12" itemprop="dateCreated datePublished" datetime="2020-02-05T23:22:12+09:00">2020-02-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/05/enabling-swap-in-k8s/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/05/enabling-swap-in-k8s/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="kubernetes는-swap을-사용하지-않는-것을-권장한다"><a href="#kubernetes는-swap을-사용하지-않는-것을-권장한다" class="headerlink" title="kubernetes는 swap을 사용하지 않는 것을 권장한다"></a>kubernetes는 swap을 사용하지 않는 것을 권장한다</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.evernote.com/l/AWjKo9GOS9pFFp7JEYCZkBXiRvpQe6W3jtw/">이러한 이유들 때문인데…</a><ul>
<li>요약하자면, <strong>QoS 개념과 상충</strong>될 뿐더러 swap을 지원하려면 고려해야할 게 많으므로 당장은 생각하지 않겠다는 입장</li>
</ul>
</li>
</ul>
<h2 id="그럼에도-불구하고-swap을-써보겠다면…"><a href="#그럼에도-불구하고-swap을-써보겠다면…" class="headerlink" title="그럼에도 불구하고 swap을 써보겠다면…"></a>그럼에도 불구하고 swap을 써보겠다면…</h2><ul>
<li>테스트한 kubernetes 버전  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/environment.png" alt="테스트 환경"></li>
</ul>
<h3 id="kubernetes-구성할-때-swap을-무시해보자"><a href="#kubernetes-구성할-때-swap을-무시해보자" class="headerlink" title="kubernetes 구성할 때 swap을 무시해보자"></a>kubernetes 구성할 때 swap을 무시해보자</h3><ul>
<li>swap 파티션 만들고 켜기  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fallocate -l 1G /swapfile</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1024 count=1048576</span><br><span class="line">mkswap /swapfile</span><br><span class="line">swapon /swapfile</span><br><span class="line">swapon --show</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/master-create-swap.png" alt="swap 생성"></li>
<li>kubelet config 변경 후 적용<ul>
<li>kubeadm init 전에는 &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml이 없다는 메세지가 출력되면서 kubelet 재기동이 되지 않는다.<br>  kubeadm init할 때 어차피 kubelet 기동하는 단계가 있으므로 일단 config 적용까지만 한다.  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;9s/^/Environment=&quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&quot;\n/&#x27;</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/master-kubelet-changed-config.png" alt="kubelet config 변경 후 적용"></li>
</ul>
</li>
<li>kubeadm init 시 –ignore-preflight-errors 옵션 추가<ul>
<li>사용할 CNI에 따라 추가해야하는 옵션이 다르다. flannel을 사용하는 예시이다.  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=Swap</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/master-kubeamd-init-1.png" alt="kubeadm init"></li>
<li>kube config를 복사(kubeadm init 결과를 잘 복사해둘 것)<br>  <img src="/images/enabling-swap-in-k8s/master-kubeamd-init-2.png" alt="kubeadm init 결과">  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/master-copy-kube-config.png" alt="kube config 복사"></li>
</ul>
</li>
<li>kubelet 상태 확인  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/master-kubelet-status-after-init.png" alt="kubelet status 확인"></li>
<li>worker node도 swap을 켜고 kubelet config를 바꾸기  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fallocate -l 1G /swapfile</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1024 count=1048576</span><br><span class="line">mkswap /swapfile</span><br><span class="line">swapon /swapfile</span><br><span class="line">swapon --show</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/worker2-creating-swap.png" alt="swap 생성">  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;9s/^/Environment=&quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&quot;\n/&#x27;</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/worker2-changed-kubelet-config-before-join.png" alt="kubelet config 변경"></li>
<li>node join 시 –ignore-preflight-errors&#x3D;Swap 추가  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 192.168.122.50:6443 --token xz93oe.p1ib3ffwcia3idr4 --discovery-token-ca-cert-hash sha256:64992300193c766f4bba22ad0e8d3279d78167f1eeb110d9922c635af3b2c90a --ignore-preflight-errors=Swap</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/worker-node-join.png" alt="node join"></li>
</ul>
<h3 id="이미-구성한-kubernetes에서-swap을-켜보자"><a href="#이미-구성한-kubernetes에서-swap을-켜보자" class="headerlink" title="이미 구성한 kubernetes에서 swap을 켜보자"></a>이미 구성한 kubernetes에서 swap을 켜보자</h3><ul>
<li>worker2의 kubelet 상태 확인  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/kubelet-worker2-before.png" alt="테스트 전 worker2의 kubelet 상태"></li>
<li>swapon &#x2F;swapfile 후 kubelet 재기동  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">swapon /swapfile</span><br><span class="line">swapon --show</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/worker2-kubelet-restart-with-swap.png" alt="swap 주고 kubelet 재기동"></li>
<li>kubelet configure 파일 수정  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;9s/^/Environment=&quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&quot;\n/&#x27;</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
  <img src="/images/enabling-swap-in-k8s/worker2-changed-kubelet-config.png" alt="kubelet config 변경 후 재기동"></li>
</ul>
<h2 id="kubelet에서-swap-check하는-코드"><a href="#kubelet에서-swap-check하는-코드" class="headerlink" title="kubelet에서 swap check하는 코드"></a>kubelet에서 swap check하는 코드</h2><ul>
<li>–fail-swap-on은 default로 true</li>
<li>–fail-swap-on이 true인 경우, &#x2F;proc&#x2F;swaps를 읽어서 swap 여부 확인 (<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/33aa665c344f91c10a15f0efda730e171b544d96/pkg/kubelet/cm/container_manager_linux.go#L209">소스코드</a>)<ul>
<li><img src="/images/enabling-swap-in-k8s/kubelet-src-check-swap.png" alt="swap check하는 부분"><ul>
<li>swap을 사용할 경우, &#x2F;proc&#x2F;swaps에서 두 번째 줄이 존재함<br>  <img src="/images/enabling-swap-in-k8s/proc-swaps-using-swap.png" alt="swap 사용 시"></li>
<li>swap을 사용하지 않는 경우, 두 번째 줄은 존재하지 않음<br>  <img src="/images/enabling-swap-in-k8s/proc-swaps-not-using-swap.png" alt="swap 미사용 시"></li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2019/12/19/push-image-to-private-registry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/19/push-image-to-private-registry/" class="post-title-link" itemprop="url">Docker private registry에 image push하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-19 23:04:46" itemprop="dateCreated datePublished" datetime="2019-12-19T23:04:46+09:00">2019-12-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/12/19/push-image-to-private-registry/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/19/push-image-to-private-registry/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="private-registry-등록하기"><a href="#private-registry-등록하기" class="headerlink" title="private registry 등록하기"></a>private registry 등록하기</h2><h3 id="docker-설정-추가"><a href="#docker-설정-추가" class="headerlink" title="docker 설정 추가"></a>docker 설정 추가</h3><p>&#x2F;etc&#x2F;docker&#x2F;daemon.json에 아래의 내용을 추가</p>
<pre>
    <code>
    vi /etc/docker/daemon.json
    &#123; "insecure-registries":["192.168.122.57:5000"] &#125;
    </code>
</pre>

<h3 id="docker-설정-적용하기"><a href="#docker-설정-적용하기" class="headerlink" title="docker 설정 적용하기"></a>docker 설정 적용하기</h3><pre>
    <code>
    systemctl restart docker
    </code>
</pre>


<h2 id="이미지-준비"><a href="#이미지-준비" class="headerlink" title="이미지 준비"></a>이미지 준비</h2><h3 id="원하는-이미지를-docker-hub에서-받아오기"><a href="#원하는-이미지를-docker-hub에서-받아오기" class="headerlink" title="원하는 이미지를 docker hub에서 받아오기"></a>원하는 이미지를 docker hub에서 받아오기</h3><p>docker pull {name}:{tag}</p>
<pre>
    <code>
    docker pull nvidia/k8s-device-plugin:1.0.0-beta4
    </code>
</pre>

<h3 id="tar로-존재하던-이미지를-load하기"><a href="#tar로-존재하던-이미지를-load하기" class="headerlink" title="tar로 존재하던 이미지를 load하기"></a>tar로 존재하던 이미지를 load하기</h3><p>docker load -i {tar file name}</p>
<pre>
    <code>
    docker load -i k8s-device-plugin.tar
    </code>
</pre>

<h2 id="이미지-push"><a href="#이미지-push" class="headerlink" title="이미지 push"></a>이미지 push</h2><h3 id="image-이름을-변경하기"><a href="#image-이름을-변경하기" class="headerlink" title="image 이름을 변경하기"></a>image 이름을 변경하기</h3><p>docker tag {name}:{tag} {private registry ip}:{port}&#x2F;{name}:{tag}</p>
<pre>
    <code>
    docker tag nvidia/k8s-device-plugin:1.0.0-beta4 192.168.122.57:5000/k8s-device-plugin:1.0.0-beta4
    </code>
</pre>

<h3 id="image-업로드하기"><a href="#image-업로드하기" class="headerlink" title="image 업로드하기"></a>image 업로드하기</h3><p>docker push {바꾼 이미지 이름}</p>
<pre>
    <code>
    docker push 192.168.122.57:5000/k8s-device-plugin:1.0.0-beta4
    </code>
</pre>

<h2 id="결과-확인"><a href="#결과-확인" class="headerlink" title="결과 확인"></a>결과 확인</h2><h3 id="registry에서-이미지-리스트-확인하기"><a href="#registry에서-이미지-리스트-확인하기" class="headerlink" title="registry에서 이미지 리스트 확인하기"></a>registry에서 이미지 리스트 확인하기</h3><pre>
    <code>
    curl -X GET 172.21.3.6:5000/v2/_catalog
    </code>
</pre>

<h3 id="registry에서-이미지-tag-확인하기"><a href="#registry에서-이미지-tag-확인하기" class="headerlink" title="registry에서 이미지 tag 확인하기"></a>registry에서 이미지 tag 확인하기</h3><pre>
    <code>
    curl -X GET 172.21.3.6:5000/v2/k8s-device-plugin/tags/list
    </code>
</pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2018/09/04/cloud-init-and-metadata-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/04/cloud-init-and-metadata-service/" class="post-title-link" itemprop="url">clout-init과 metadata service(feat.cloudbase-init)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-04 14:20:03" itemprop="dateCreated datePublished" datetime="2018-09-04T14:20:03+09:00">2018-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/04/cloud-init-and-metadata-service/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/04/cloud-init-and-metadata-service/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>이 모든 것은 windows vm을 회사의 cloud 환경에 띄우기 위해 시작되었다.<br>이것을 하기 위해 cloud-init이 무엇인지 알게 되었고, 구글링하고 구글링하고 또 구글링하고…<br>구글링했던 지난 날이 아까워서라도 남겨놔야겠다.</p>
<h2 id="cloud-init"><a href="#cloud-init" class="headerlink" title="cloud-init"></a>cloud-init</h2><p>cloud-init은 vm을 datasource를 기반으로 초기화하기 위해 vm 내부에서 동작하는 프로그램이다.<br>애석하게도 linux 계열의 guest OS만 지원하고, windows를 guest OS로 사용한다면 cloudbase-init을 설치해야 한다.<br>큰 뼈대는 cloud-init이나 cloudbase-init이나 동일하므로 cloud-init을 기준으로 설명하겠다.<br>(실제로도 cloudbase-init의 설명을 읽다보면 cloud-init을 기준으로 다른 점만 기술되어있는 느낌이다.)</p>
<h3 id="datasource"><a href="#datasource" class="headerlink" title="datasource"></a>datasource</h3><p>datasource란 metadata와 userdata, 그리고 vendordata를 포함한 instance의 data를 의미한다.<br>metadata는 intstance 관리를 위해 cloud platform가 설정하는 정보로, instance id나 hostname, ssh-key 등을 설정할 수 있다.<br>userdata는 말그대로 사용자가 설정하는 데이터이고, user와 group, write_files, bootcmd&#x2F;runcmd 등을 설정할 수 있다.<br>vendordata는 cloud platform이 정하는 userdata 급의 data로, 그 항목은 userdata와 동일하다. 이 때 이를 사용하고 말고는 사용자가 결정한다.</p>
<h4 id="datasource의-종류"><a href="#datasource의-종류" class="headerlink" title="datasource의 종류"></a>datasource의 종류</h4><p>이 datasource를 얻어오는 방법은 크게 두 가지인데, local로 얻어오는 방법과 network로 얻어오는 방법이다.<br>local로 얻어오는 방법은 datasource를 iso파일로 생성하여 instance에 삽입한 것을 읽어오는 것이고,<br>cloud-init에서 분류하는 datasource 종류 중 NoCloud(cloud platform을 사용하지 않는 경우를 의미하며 cloud-config format 사용), Config Drive(Openstack format 사용), Alt Cloud(RHEvm, vShpere) 등이 있다.<br>network로 얻어오는 방법은 cloud platform이 제공하는 metadata service를 통해 얻어오는 방법이며,<br>Openstack, EC2, GCE, Azure, Aliyun 등 cloud platform의 종류별로 cloud-init이 구분하고 있다.</p>
<h3 id="cloud-init-동작-과정"><a href="#cloud-init-동작-과정" class="headerlink" title="cloud-init 동작 과정"></a>cloud-init 동작 과정</h3><p>cloud-init은 각 모듈이 systemd의 service로 등록되어 instance의 booting 과정 중에 실행된다.<br>모듈별 동작은 크게 의미 없으니 다음 그림처럼 굵직하게만 살펴보겠다.<br><img src="/images/cloud-init-and-metadata-service/cloud-init-working-process.png"></p>
<h4 id="local-datasource-탐색-amp-network-configuration-결정"><a href="#local-datasource-탐색-amp-network-configuration-결정" class="headerlink" title="local datasource 탐색 &amp; network configuration 결정"></a>local datasource 탐색 &amp; network configuration 결정</h4><p>cloud-init이 실행되면 가장 우선적으로 local datasource를 탐색하고, 어떤 network configuration을 사용할 지 결정한다.<br>network configuration을 ‘결정’한다고 표현하는 것은, cloud-init은 netplan(ubuntu 18.04 기준)과 같은 네트워크 서비스에 설정을 집어넣는 역할까지만 하기 때문이다.<br>실제 network configure는 guest os의 네트워크 서비스가 해준다.<br>만약 local datasource가 존재하지 않는다면 fallback 로직을 타게 되는데, cloud-init에서는 이를 dhcp로 규정하고 있다.<br>사용자가 원하지 않는다면 cloud-init의 network configuration을 disable할 수도 있다.<br>이렇게 cloud-init이 결정한 network configuration을 바탕으로 guest os의 네트워크 서비스가 세팅을 해준 뒤에 cloud-init는 다음 작업을 수행한다.</p>
<h4 id="network-datasource-검색"><a href="#network-datasource-검색" class="headerlink" title="network datasource 검색"></a>network datasource 검색</h4><p>local datasource가 있었다면 static이던 dhcp던 네트워크가 설정된 후 이 과정은 패스할 것이고,<br>local datasource가 없었다면 dhcp로 네트워크가 설정된 후 이 과정을 진행할 것이다.<br>cloud-init의 소스에는 datasource 종류별로 어떤 metadata service를 사용할 지 하드코딩되어있다.<br>(하드코딩이라도 표현해도 될지는 잘 모르겠다. 무튼 요지는 cloud-init이 지원하는 platform의 metadata service만 사용 가능하다는 점이다.)<br>이 부분은 잠시 뒤 metadata service에서 자세히 다뤄보겠다.</p>
<h4 id="instance-초기화-진행"><a href="#instance-초기화-진행" class="headerlink" title="instance 초기화 진행"></a>instance 초기화 진행</h4><p>이제 얻어온 datasource를 바탕으로 instance를 초기화한다.</p>
<p>이와 같은 과정을 거쳐 cloud-init은 vm을 personalize한다.<br>이제 cloud-init을 설명하면서 여러 차례 언급되었던 metadata service에 대해 알아보자.</p>
<h2 id="metadata-service"><a href="#metadata-service" class="headerlink" title="metadata service"></a>metadata service</h2><p>metadata service는 instance를 관리하는 데에 필요한 정보를 검색하는 서비스이다.<br>cloud-init이 이 서비스를 instance를 초기화할 때 사용하는 대표적인 예일 뿐, 사용자도 해당 서비스를 사용하여 instance의 metadata를 조회할 수 있다.</p>
<h3 id="metadata-service-사용-방법"><a href="#metadata-service-사용-방법" class="headerlink" title="metadata service 사용 방법"></a>metadata service 사용 방법</h3><p>이 서비스는 rest api로 제공되는데, cloud platform별로 사용 방법이 다르다.<br><img src="/images/cloud-init-and-metadata-service/metadata-svc.png"><br>openstack의 경우 metadata를 파일로 한 번에 리턴해주지만, 대부분의 플랫폼은 metadata 항목마다 request를 보내어 그 값을 리턴받는다.<br>사용 방법은 각 공홈에 나와있는데, 대표적으로 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-instance-metadata.html">ec2의 metadata service 사용방법</a>을 읽어보면 감이 올 것이다.<br>여기에서 내가 궁금했던 것이 두 가지 있는데, 첫 번째는 openstack와 ec2의 metadata service는 왜 169.254.169.254를 사용하는가?였다.<br>이것은 GCE와 Aliyun은 저 ip를 사용하지 않는다는 것을 몰랐을 때 생긴 궁금증이라, 저 ip에 꽂혀서 삽질했던 지난 날을 생각하면… (부들부들)<br>그리고 두 번째는 이 http request에는 instance에 대한 아무런 정보도 없는데 metadata service가 이 instance specific한 어떻게 돌려주는가?였다.<br>우선 두 번째 의문부터 풀어보도록 하자.</p>
<h3 id="openstack의-metadata-service-동작-과정"><a href="#openstack의-metadata-service-동작-과정" class="headerlink" title="openstack의 metadata service 동작 과정"></a>openstack의 metadata service 동작 과정</h3><p>instance를 특정짓는 과정을 알아보기 위해서는 metadata service가 어떤 방식으로 돌아가는 지 알 필요가 있다.<br>모든 플랫폼을 다 살펴볼 순 없으므로 openstack을 기준으로 조사를 했다.</p>
<p>(작성중…)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jwcheong0420.github.io/2018/08/09/how-to-install-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Joowon Cheong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="삽질특기생">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/09/how-to-install-k8s/" class="post-title-link" itemprop="url">k8s 설치 방법</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-09 18:38:15" itemprop="dateCreated datePublished" datetime="2018-08-09T18:38:15+09:00">2018-08-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/08/09/how-to-install-k8s/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/09/how-to-install-k8s/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>k8s의 pod에 대해 조사를 해야하는 일이 생겨서 개인 컴퓨터에 k8s를 설치해보았다.<br>원래 k8s는 세 대 이상의 클러스터에 구성할 것을 권장하는 것으로 알고 있지만 나는 테스트용이므로 한 대로만 구성하였다.<br>k8s가 무엇인지 간략하게 알아보고, 설치 과정에 대해 기술하도록 하겠다.</p>
<h2 id="kubernetes란"><a href="#kubernetes란" class="headerlink" title="kubernetes란"></a>kubernetes란</h2><p>kubernete(k8s)는 docker orchetration tool로, application container의 deploy, scaling, operating 자동화를 위한 플랫폼이다.<br>쉽게 설명하자면 k8s는 사용자가 기대하는 상태로 동작하도록 application을 생성하고 실행 상태를 유지하는 것이 목적이라고 할 수 있다.<br>k8s는 여러 노드를 하나의 클러스터로 관리하는데, 하나의 master node와 그 외 여러 일반 node로 구성된다. <del>일반 node는 minions라고도 불리는 모양이다.(미니언즈라니…귀여워…)</del><br>master node에는 클러스터를 관리하는 목적의 controller pod들이 실행되어야 한다.<br>일반 node들은 kubelet 데몬과 docker 데몬이 실행되고 있어야 하며, container의 묶음인 pod들이 실행되는 형태이다.</p>
<blockquote>
<p>20&#x2F;04&#x2F;06 수정<br>minion이라고 불렸던 것은 아주 오래전의 얘기인 것 같다. 이 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/1111">github issue</a>에서 minion이라는 용어가 헷갈리므로 변경하자는 의견이 오고 갔다.</p>
</blockquote>
<h2 id="k8s-설치-방법"><a href="#k8s-설치-방법" class="headerlink" title="k8s 설치 방법"></a>k8s 설치 방법</h2><h3 id="docker-설치"><a href="#docker-설치" class="headerlink" title="docker 설치"></a>docker 설치</h3><p>우선 k8s가 docker 기반의 container를 관리하므로, docker를 설치해야한다.<br>나는 이미 설치되어있어서 해당 과정을 생략했는데, <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-using-the-repository">docker 공식 홈페이지의 설치 방법</a>을 참고하여 설치하면 된다.</p>
<h3 id="k8s-설치"><a href="#k8s-설치" class="headerlink" title="k8s 설치"></a>k8s 설치</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add</span><br><span class="line">$ vi /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb http://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install --no-install-recommends kubelet kubeadm kubernetes-cni</span><br></pre></td></tr></table></figure>
<p>패키지 설치 시 –no-install-recommends 옵션은 해당 패지키가 실행되는 데 필요한 패키지만을 설치하겠다는 옵션이다.<br>잡다한 패키지까지 설치하는 게 싫어서 나는 항상 이 옵션을 주고 설치하는데, 저 옵션 없이 설치해도 무방하다.</p>
<h3 id="kubelet-설정"><a href="#kubelet-설정" class="headerlink" title="kubelet 설정"></a>kubelet 설정</h3><p>swap 설정을 해주어야 한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;9s/^/Environment=&quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&quot;\n/&#x27;</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="master-init"><a href="#master-init" class="headerlink" title="master init"></a>master init</h3><h4 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h4><p>kubeadm을 init해야한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors Swap</span><br></pre></td></tr></table></figure>
<p>–pod-network-cidr&#x3D;10.244.0.0&#x2F;16은 flannel을 사용하기 위한 옵션이고, –ignore-preflight-errors Swap은 swap 에러를 무시하기 위한 옵션이다.<br>위 커맨드를 실행하면 To start using your cluster라며 아래와 같은 커맨드가 나열될 것이다.<br>하라는 대로 따라 치면 되겠다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<h4 id="flannel-적용"><a href="#flannel-적용" class="headerlink" title="flannel 적용"></a>flannel 적용</h4><p>보통 pod의 network로 flannel을 많이 사용한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<h4 id="master-node에-schedule-가능하도록-설정"><a href="#master-node에-schedule-가능하도록-설정" class="headerlink" title="master node에 schedule 가능하도록 설정"></a>master node에 schedule 가능하도록 설정</h4><p>원래 master node에는 schedule하지 않는 것이 default 설정이다. 즉 master node에는 별도의 설정이 없으면 pod이 뜨지 않는다.<br>현재 나의 테스트 환경은 single-node cluster이므로, master에 schedule이 가능하도록 설정을 바꿔야 한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>
<p>결과로 node ‘&lt;hostname&gt;‘ untainted가 나오면 성공이다.</p>
<h2 id="trouble-shooting"><a href="#trouble-shooting" class="headerlink" title="trouble shooting"></a>trouble shooting</h2><h3 id="reboot시-node-not-ready-에러-발생"><a href="#reboot시-node-not-ready-에러-발생" class="headerlink" title="reboot시 node not ready 에러 발생"></a>reboot시 node not ready 에러 발생</h3><p>reboot 시 node not ready 에러가 발생했다.<br>에러는 다음과 같은 커맨드로 node 정보를 조회하여 확인하였고, 여기서 dev는 node 이름이다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node dev</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Ready            False   Tue, 15 May 2018 10:35:18 +0900   Tue, 15 May 2018 10:26:25 +0900   KubeletNotReady              runtime network not ready: NetworkReady&#x3D;false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized</p>
</blockquote>
<p>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;10-kubeadm.conf에서 KUBELET_NETWORK_ARGS line을 삭제했더니 정상 동작하였다.<br>해당 과정은 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/48798">kubernetes github</a>을 참고하였다.</p>
<h3 id="swap-에러-발생"><a href="#swap-에러-발생" class="headerlink" title="swap 에러 발생"></a>swap 에러 발생</h3><p>master init 과정에서 다음 커맨드를 실행했을 때 swap을 disable하지 않았다며 에러가 발생했다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[ERROR Swap]: running with swap on is not supported. Please disable swap<br>[preflight] If you know what you are doing, you can make a check non-fatal with <code>--ignore-preflight-errors=...</code></p>
</blockquote>
<p>위의 kubelet 설정 방법대로 따라하고, kubeadm init시 swap error를 ignore하는 설정을 잊지 않도록 한다.</p>
<h2 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h2><p>이 포스팅에서는 k8s를 설치하는 방법에 대해서 알아보았다.<br>시작이 반이라지만 k8s를 설치한 것만으로 반을 했다고 볼 수는 없다ㅋㅋㅋ<br>k8s를 제대로 사용하려면 pod도 알아야하고 service와 deployment 등등 알아야할 것이 산더미이다.<br>시간이 되는 대로 내가 조사한 것에 대해 포스팅을 해야겠다.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Joowon Cheong</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Joowon Cheong</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://jwcheong0420-github-io.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
